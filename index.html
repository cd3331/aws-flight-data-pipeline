<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Data Pipeline Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
        }

        .metric-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
            margin: 20px auto;
            display: block;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        .footer {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Flight Data Pipeline</h1>
            <p>Real-time Aviation Data from OpenSky Network</p>
        </div>

        <div id="error-container"></div>

        <button id="refresh-btn" class="refresh-btn" onclick="refreshData()">
            <span id="refresh-text">Refresh Data</span>
            <span id="refresh-spinner" class="loading-spinner" style="display: none;"></span>
        </button>

        <div class="dashboard">
            <!-- Flight Statistics Card -->
            <div class="card">
                <h3>üìä Flight Statistics</h3>
                <div class="metric">
                    <span class="metric-label">Total Flights</span>
                    <span class="metric-value" id="total-flights">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Airborne</span>
                    <span class="metric-value" id="flights-airborne">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">On Ground</span>
                    <span class="metric-value" id="flights-ground">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">With Position</span>
                    <span class="metric-value" id="flights-position">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
            </div>

            <!-- Processing Status Card -->
            <div class="card">
                <h3>‚öôÔ∏è Processing Status</h3>
                <div class="metric">
                    <span class="metric-label">Records Processed</span>
                    <span class="metric-value" id="records-processed">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value">
                        <span id="processing-status" class="status loading">Loading</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Execution ID</span>
                    <span class="metric-value" id="execution-id">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Last Updated</span>
                    <span class="metric-value" id="last-updated">-</span>
                </div>
            </div>

            <!-- Data Source Card -->
            <div class="card">
                <h3>üóÇÔ∏è Data Source</h3>
                <div class="metric">
                    <span class="metric-label">S3 File</span>
                    <span class="metric-value" id="s3-file">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">File Size</span>
                    <span class="metric-value" id="file-size">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Data Timestamp</span>
                    <span class="metric-value" id="data-timestamp">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Bucket</span>
                    <span class="metric-value" id="bucket-name">-</span>
                </div>
            </div>

            <!-- Flight Performance Card -->
            <div class="card">
                <h3>üöÄ Flight Performance</h3>
                <div class="metric">
                    <span class="metric-label">Mean Altitude</span>
                    <span class="metric-value" id="mean-altitude">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Altitude</span>
                    <span class="metric-value" id="max-altitude">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Mean Speed</span>
                    <span class="metric-value" id="mean-speed">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Speed</span>
                    <span class="metric-value" id="max-speed">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Top Countries Table -->
        <div class="card">
            <h3>üåç Top Countries by Flight Count</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Country</th>
                        <th>Flights</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody id="countries-table">
                    <tr>
                        <td colspan="4" style="text-align: center;">
                            <span class="loading-spinner"></span> Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Fastest Aircraft Table -->
        <div class="card">
            <h3>üèÜ Fastest Aircraft</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Callsign</th>
                        <th>Country</th>
                        <th>Speed (knots)</th>
                        <th>Altitude (ft)</th>
                    </tr>
                </thead>
                <tbody id="fastest-table">
                    <tr>
                        <td colspan="5" style="text-align: center;">
                            <span class="loading-spinner"></span> Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p>Powered by OpenSky Network ‚Ä¢ Real-time flight data processing ‚Ä¢ Last refresh: <span id="last-refresh">-</span></p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE: 'https://acikl2oamh.execute-api.us-east-1.amazonaws.com/prod',
            REFRESH_INTERVAL: 10 * 60 * 1000, // 10 minutes
            TIMEOUT: 15000 // 15 seconds
        };

        let refreshInterval;

        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function formatBytes(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 Bytes';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDateTime(dateString) {
            try {
                return new Date(dateString).toLocaleString();
            } catch {
                return dateString;
            }
        }

        function extractFileNameFromPath(s3Key) {
            if (!s3Key) return '-';
            const parts = s3Key.split('/');
            return parts[parts.length - 1];
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }

        function setRefreshButtonState(loading) {
            const btn = document.getElementById('refresh-btn');
            const text = document.getElementById('refresh-text');
            const spinner = document.getElementById('refresh-spinner');

            btn.disabled = loading;
            text.style.display = loading ? 'none' : 'inline';
            spinner.style.display = loading ? 'inline-block' : 'none';
        }

        // Main data fetching function
        async function fetchFlightData() {
            console.log('üîÑ Fetching flight data from API...');

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            try {
                const response = await fetch(`${CONFIG.API_BASE}/data`, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ API response received:', data);

                // Validate response structure
                if (!data.statistics || !data.executionResult) {
                    throw new Error('Invalid API response format');
                }

                return data;

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out');
                }
                throw error;
            }
        }

        // Update dashboard with real data
        function updateDashboard(data) {
            console.log('üìä Updating dashboard with data...');

            const { statistics, executionResult, metadata } = data;

            // Flight Statistics
            document.getElementById('total-flights').textContent = formatNumber(statistics.total_flights || 0);
            document.getElementById('flights-airborne').textContent = formatNumber(statistics.flights_airborne || 0);
            document.getElementById('flights-ground').textContent = formatNumber(statistics.flights_on_ground || 0);
            document.getElementById('flights-position').textContent = formatNumber(statistics.flights_with_position || 0);

            // Processing Status
            document.getElementById('records-processed').textContent = formatNumber(executionResult.records_processed || 0);

            const statusElement = document.getElementById('processing-status');
            statusElement.textContent = executionResult.status || 'Unknown';
            statusElement.className = `status ${(executionResult.status === 'SUCCESS') ? 'success' : 'error'}`;

            document.getElementById('execution-id').textContent = executionResult.execution_id || '-';
            document.getElementById('last-updated').textContent = formatDateTime(executionResult.last_modified);

            // Data Source
            document.getElementById('s3-file').textContent = extractFileNameFromPath(executionResult.s3_key);
            document.getElementById('file-size').textContent = formatBytes(metadata.file_size_bytes || 0);
            document.getElementById('data-timestamp').textContent = formatDateTime(statistics.data_timestamp);
            document.getElementById('bucket-name').textContent = metadata.bucket_name || '-';

            // Flight Performance
            const altStats = statistics.altitude_stats || {};
            const speedStats = statistics.speed_stats || {};

            document.getElementById('mean-altitude').textContent =
                altStats.mean_altitude_ft ? `${Math.round(altStats.mean_altitude_ft).toLocaleString()} ft` : '-';
            document.getElementById('max-altitude').textContent =
                altStats.max_altitude_ft ? `${Math.round(altStats.max_altitude_ft).toLocaleString()} ft` : '-';
            document.getElementById('mean-speed').textContent =
                speedStats.mean_speed_knots ? `${Math.round(speedStats.mean_speed_knots)} knots` : '-';
            document.getElementById('max-speed').textContent =
                speedStats.max_speed_knots ? `${Math.round(speedStats.max_speed_knots)} knots` : '-';

            // Update tables
            updateCountriesTable(statistics.top_10_countries || {}, statistics.total_flights || 0);
            updateFastestTable(statistics.top_10_fastest_aircraft || []);

            // Update last refresh time
            document.getElementById('last-refresh').textContent = new Date().toLocaleString();

            console.log('‚úÖ Dashboard updated successfully');
        }

        function updateCountriesTable(countries, totalFlights) {
            const tbody = document.getElementById('countries-table');
            if (!countries || Object.keys(countries).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No data available</td></tr>';
                return;
            }

            const rows = Object.entries(countries)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([country, count], index) => {
                    const percentage = totalFlights > 0 ? ((count / totalFlights) * 100).toFixed(1) : '0.0';
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${country}</td>
                            <td>${formatNumber(count)}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                }).join('');

            tbody.innerHTML = rows;
        }

        function updateFastestTable(aircraft) {
            const tbody = document.getElementById('fastest-table');
            if (!aircraft || aircraft.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data available</td></tr>';
                return;
            }

            const rows = aircraft.slice(0, 10).map((plane, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${plane.callsign || '-'}</td>
                    <td>${plane.origin_country || '-'}</td>
                    <td>${plane.velocity_knots ? Math.round(plane.velocity_knots).toLocaleString() : '-'}</td>
                    <td>${plane.baro_altitude_ft ? Math.round(plane.baro_altitude_ft).toLocaleString() : '-'}</td>
                </tr>
            `).join('');

            tbody.innerHTML = rows;
        }

        // Refresh data function
        async function refreshData() {
            setRefreshButtonState(true);
            clearError();

            try {
                const data = await fetchFlightData();
                updateDashboard(data);
                console.log('üîÑ Data refresh completed');
            } catch (error) {
                console.error('‚ùå Failed to refresh data:', error);
                showError(`Failed to load flight data: ${error.message}`);
            } finally {
                setRefreshButtonState(false);
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            console.log('üöÄ Initializing Flight Data Dashboard...');
            await refreshData();

            // Set up auto-refresh
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(refreshData, CONFIG.REFRESH_INTERVAL);

            console.log(`‚è∞ Auto-refresh enabled (${CONFIG.REFRESH_INTERVAL / 60000} minutes)`);
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>