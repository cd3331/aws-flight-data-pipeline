<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Data Pipeline Dashboard</title>
    <style>
        :root {
            /* Primary Colors */
            --color-primary: #304CB2;        /* Bold Blue */
            --color-primary-light: #3453C4;  /* Cerulean Blue (lighter variant) */
            --color-neutral: #FFFFFF;        /* White for contrast */

            /* Secondary Colors */
            --color-secondary: #E51D23;      /* Bright Red (CTA buttons, highlights) */
            --color-accent: #F9B612;         /* Sunshine Yellow (secondary accents, alerts) */
            --color-gray: #CCCCCC;           /* Neutral Gray (borders, backgrounds, text) */

            /* Text Colors */
            --text-dark: #111111;            /* Body text */
            --text-light: #FFFFFF;           /* On dark backgrounds */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: var(--text-light);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--color-neutral);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--color-gray);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(48, 76, 178, 0.15);
        }

        .card h3 {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-gray);
        }

        .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .metric-label {
            font-weight: 500;
            color: var(--text-dark);
            opacity: 0.7;
        }

        .metric-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-dark);
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status.success {
            background: rgba(48, 76, 178, 0.1);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .status.loading {
            background: rgba(249, 182, 18, 0.1);
            color: var(--color-accent);
            border: 1px solid var(--color-accent);
        }

        .status.error {
            background: rgba(229, 29, 35, 0.1);
            color: var(--color-secondary);
            border: 1px solid var(--color-secondary);
        }

        .refresh-btn {
            background: var(--color-secondary);
            color: var(--text-light);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(229, 29, 35, 0.3);
        }

        .refresh-btn:hover {
            background: #c91a20;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 29, 35, 0.4);
        }

        .refresh-btn:disabled {
            background: var(--color-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--color-gray);
        }

        .data-table th {
            background: rgba(48, 76, 178, 0.05);
            font-weight: 600;
            color: var(--color-primary);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(204, 204, 204, 0.3);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(229, 29, 35, 0.1);
            color: var(--color-secondary);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--color-secondary);
        }

        .footer {
            text-align: center;
            color: var(--text-light);
            opacity: 0.8;
            margin-top: 40px;
        }

        .architecture-diagram {
            margin: 30px 0;
            max-width: 100%;
            overflow: hidden;
        }

        .architecture-diagram svg {
            width: 100%;
            height: auto;
            max-width: 1000px;
            margin: 0 auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Flight Data Pipeline</h1>
            <p>Real-time Aviation Data from OpenSky Network</p>

            <!-- Architecture Diagram -->
            <div class="architecture-diagram">
                <svg viewBox="0 0 1000 300" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="primaryGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#304CB2;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#3453C4;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="secondaryGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#E51D23;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c91a20;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="accentGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#F9B612;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#e6a310;stop-opacity:1" />
                        </linearGradient>
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="2" dy="4" stdDeviation="3" flood-color="rgba(0,0,0,0.3)"/>
                        </filter>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#FFFFFF" />
                        </marker>
                    </defs>

                    <!-- Background -->
                    <rect width="1000" height="300" fill="url(#primaryGradient)" rx="10"/>

                    <!-- Step 1: OpenSky API -->
                    <g transform="translate(50, 100)">
                        <rect width="120" height="80" rx="15" fill="#FFFFFF" filter="url(#shadow)" stroke="#304CB2" stroke-width="2"/>
                        <text x="60" y="30" text-anchor="middle" fill="#304CB2" font-size="12" font-weight="600">OpenSky</text>
                        <text x="60" y="45" text-anchor="middle" fill="#304CB2" font-size="12" font-weight="600">Network</text>
                        <text x="60" y="60" text-anchor="middle" fill="#111111" font-size="10">API Data</text>
                        <circle cx="25" cy="25" r="8" fill="#F9B612"/>
                        <text x="25" y="30" text-anchor="middle" fill="#FFFFFF" font-size="10" font-weight="bold">üåê</text>
                    </g>

                    <!-- Arrow 1 -->
                    <line x1="170" y1="140" x2="230" y2="140" stroke="#FFFFFF" stroke-width="3" marker-end="url(#arrowhead)"/>
                    <text x="200" y="130" text-anchor="middle" fill="#FFFFFF" font-size="10" font-weight="500">Real-time</text>

                    <!-- Step 2: Lambda Functions -->
                    <g transform="translate(250, 100)">
                        <rect width="120" height="80" rx="15" fill="#FFFFFF" filter="url(#shadow)" stroke="#E51D23" stroke-width="2"/>
                        <text x="60" y="30" text-anchor="middle" fill="#E51D23" font-size="12" font-weight="600">Lambda</text>
                        <text x="60" y="45" text-anchor="middle" fill="#E51D23" font-size="12" font-weight="600">Functions</text>
                        <text x="60" y="60" text-anchor="middle" fill="#111111" font-size="10">Serverless</text>
                        <circle cx="25" cy="25" r="8" fill="#304CB2"/>
                        <text x="25" y="30" text-anchor="middle" fill="#FFFFFF" font-size="10" font-weight="bold">Œª</text>
                    </g>

                    <!-- Arrow 2 -->
                    <line x1="370" y1="140" x2="430" y2="140" stroke="#FFFFFF" stroke-width="3" marker-end="url(#arrowhead)"/>
                    <text x="400" y="130" text-anchor="middle" fill="#FFFFFF" font-size="10" font-weight="500">Process</text>

                    <!-- Step 3: S3 Storage -->
                    <g transform="translate(450, 100)">
                        <rect width="120" height="80" rx="15" fill="#FFFFFF" filter="url(#shadow)" stroke="#F9B612" stroke-width="2"/>
                        <text x="60" y="30" text-anchor="middle" fill="#F9B612" font-size="12" font-weight="600">Amazon S3</text>
                        <text x="60" y="45" text-anchor="middle" fill="#F9B612" font-size="12" font-weight="600">Storage</text>
                        <text x="60" y="60" text-anchor="middle" fill="#111111" font-size="10">Data Lake</text>
                        <circle cx="25" cy="25" r="8" fill="#E51D23"/>
                        <text x="25" y="30" text-anchor="middle" fill="#FFFFFF" font-size="10" font-weight="bold">üì¶</text>
                    </g>

                    <!-- Arrow 3 -->
                    <line x1="570" y1="140" x2="630" y2="140" stroke="#FFFFFF" stroke-width="3" marker-end="url(#arrowhead)"/>
                    <text x="600" y="130" text-anchor="middle" fill="#FFFFFF" font-size="10" font-weight="500">Analytics</text>

                    <!-- Step 4: Dashboard/Analytics -->
                    <g transform="translate(650, 100)">
                        <rect width="120" height="80" rx="15" fill="#FFFFFF" filter="url(#shadow)" stroke="#304CB2" stroke-width="2"/>
                        <text x="60" y="30" text-anchor="middle" fill="#304CB2" font-size="12" font-weight="600">Dashboard</text>
                        <text x="60" y="45" text-anchor="middle" fill="#304CB2" font-size="12" font-weight="600">& Analytics</text>
                        <text x="60" y="60" text-anchor="middle" fill="#111111" font-size="10">Real-time</text>
                        <circle cx="25" cy="25" r="8" fill="#F9B612"/>
                        <text x="25" y="30" text-anchor="middle" fill="#FFFFFF" font-size="10" font-weight="bold">üìä</text>
                    </g>

                    <!-- Performance Metrics -->
                    <g transform="translate(850, 50)">
                        <rect width="130" height="120" rx="10" fill="rgba(255,255,255,0.1)" stroke="#FFFFFF" stroke-width="1"/>
                        <text x="65" y="20" text-anchor="middle" fill="#FFFFFF" font-size="11" font-weight="600">Live Metrics</text>
                        <text id="diagram-records" x="10" y="40" fill="#FFFFFF" font-size="9">‚Ä¢ Loading...</text>
                        <text id="diagram-processing" x="10" y="55" fill="#FFFFFF" font-size="9">‚Ä¢ Loading...</text>
                        <text id="diagram-countries" x="10" y="70" fill="#FFFFFF" font-size="9">‚Ä¢ Loading...</text>
                        <text id="diagram-success" x="10" y="85" fill="#FFFFFF" font-size="9">‚Ä¢ Loading...</text>
                        <text id="diagram-airborne" x="10" y="100" fill="#FFFFFF" font-size="9">‚Ä¢ Loading...</text>
                    </g>

                    <!-- Subtitle -->
                    <text x="500" y="40" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="300" opacity="0.9">
                        End-to-End Serverless Flight Data Processing Pipeline
                    </text>

                    <!-- Data Flow Labels -->
                    <text x="500" y="270" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="500" opacity="0.8">
                        30-second intervals ‚Ä¢ Event-driven architecture ‚Ä¢ Auto-scaling ‚Ä¢ Cost-optimized
                    </text>
                </svg>
            </div>
        </div>

        <div id="error-container"></div>

        <button id="refresh-btn" class="refresh-btn" onclick="refreshData()">
            <span id="refresh-text">Refresh Data</span>
            <span id="refresh-spinner" class="loading-spinner" style="display: none;"></span>
        </button>

        <div class="dashboard">
            <!-- Flight Statistics Card -->
            <div class="card">
                <h3>üìä Flight Statistics</h3>
                <div class="metric">
                    <span class="metric-label">Total Flights</span>
                    <span class="metric-value" id="total-flights">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Airborne</span>
                    <span class="metric-value" id="flights-airborne">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">On Ground</span>
                    <span class="metric-value" id="flights-ground">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">With Position</span>
                    <span class="metric-value" id="flights-position">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
            </div>

            <!-- Processing Status Card -->
            <div class="card">
                <h3>‚öôÔ∏è Processing Status</h3>
                <div class="metric">
                    <span class="metric-label">Records Processed</span>
                    <span class="metric-value" id="records-processed">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value">
                        <span id="processing-status" class="status loading">Loading</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Execution ID</span>
                    <span class="metric-value" id="execution-id">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Last Updated</span>
                    <span class="metric-value" id="last-updated">-</span>
                </div>
            </div>

            <!-- Data Source Card -->
            <div class="card">
                <h3>üóÇÔ∏è Data Source</h3>
                <div class="metric">
                    <span class="metric-label">S3 File</span>
                    <span class="metric-value" id="s3-file">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">File Size</span>
                    <span class="metric-value" id="file-size">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Data Timestamp</span>
                    <span class="metric-value" id="data-timestamp">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Bucket</span>
                    <span class="metric-value" id="bucket-name">-</span>
                </div>
            </div>

            <!-- Flight Performance Card -->
            <div class="card">
                <h3>üöÄ Flight Performance</h3>
                <div class="metric">
                    <span class="metric-label">Mean Altitude</span>
                    <span class="metric-value" id="mean-altitude">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Altitude</span>
                    <span class="metric-value" id="max-altitude">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Mean Speed</span>
                    <span class="metric-value" id="mean-speed">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Speed</span>
                    <span class="metric-value" id="max-speed">
                        <span class="loading-spinner"></span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Top Countries Table -->
        <div class="card">
            <h3>üåç Top Countries by Flight Count</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Country</th>
                        <th>Flights</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody id="countries-table">
                    <tr>
                        <td colspan="4" style="text-align: center;">
                            <span class="loading-spinner"></span> Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Fastest Aircraft Table -->
        <div class="card">
            <h3>üèÜ Fastest Aircraft</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Callsign</th>
                        <th>Country</th>
                        <th>Speed (knots)</th>
                        <th>Altitude (ft)</th>
                    </tr>
                </thead>
                <tbody id="fastest-table">
                    <tr>
                        <td colspan="5" style="text-align: center;">
                            <span class="loading-spinner"></span> Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p>Powered by OpenSky Network ‚Ä¢ Real-time flight data processing ‚Ä¢ Last refresh: <span id="last-refresh">-</span></p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE: 'https://acikl2oamh.execute-api.us-east-1.amazonaws.com/prod',
            REFRESH_INTERVAL: 10 * 60 * 1000, // 10 minutes
            TIMEOUT: 15000 // 15 seconds
        };

        let refreshInterval;

        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function formatBytes(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 Bytes';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDateTime(dateString) {
            try {
                return new Date(dateString).toLocaleString();
            } catch {
                return dateString;
            }
        }

        function extractFileNameFromPath(s3Key) {
            if (!s3Key) return '-';
            const parts = s3Key.split('/');
            return parts[parts.length - 1];
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }

        function setRefreshButtonState(loading) {
            const btn = document.getElementById('refresh-btn');
            const text = document.getElementById('refresh-text');
            const spinner = document.getElementById('refresh-spinner');

            btn.disabled = loading;
            text.style.display = loading ? 'none' : 'inline';
            spinner.style.display = loading ? 'inline-block' : 'none';
        }

        // Main data fetching function
        async function fetchFlightData() {
            console.log('üîÑ Fetching flight data from API...');

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            try {
                const response = await fetch(`${CONFIG.API_BASE}/data`, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ API response received:', data);

                // Validate response structure
                if (!data.statistics || !data.executionResult) {
                    throw new Error('Invalid API response format');
                }

                return data;

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out');
                }
                throw error;
            }
        }

        // Update architecture diagram metrics
        function updateDiagramMetrics(data) {
            const { statistics, executionResult } = data;

            // Update diagram metrics with real data
            const recordsElement = document.getElementById('diagram-records');
            const processingElement = document.getElementById('diagram-processing');
            const countriesElement = document.getElementById('diagram-countries');
            const successElement = document.getElementById('diagram-success');
            const airborneElement = document.getElementById('diagram-airborne');

            if (recordsElement) {
                recordsElement.textContent = `‚Ä¢ ${formatNumber(statistics.total_flights || 0)} records`;
            }

            if (processingElement && executionResult.processing_time_seconds) {
                processingElement.textContent = `‚Ä¢ ${executionResult.processing_time_seconds}s processing`;
            } else if (processingElement) {
                processingElement.textContent = `‚Ä¢ Fast processing`;
            }

            if (countriesElement) {
                const countryCount = statistics.top_10_countries ? Object.keys(statistics.top_10_countries).length : 0;
                if (countryCount > 0) {
                    countriesElement.textContent = `‚Ä¢ ${countryCount}+ countries`;
                } else {
                    countriesElement.textContent = `‚Ä¢ Global coverage`;
                }
            }

            if (successElement) {
                const status = executionResult.status === 'SUCCESS' ? '100% success' : 'Processing';
                successElement.textContent = `‚Ä¢ ${status}`;
            }

            if (airborneElement) {
                const airborne = statistics.flights_airborne || 0;
                if (airborne > 0) {
                    airborneElement.textContent = `‚Ä¢ ${formatNumber(airborne)} airborne`;
                } else {
                    airborneElement.textContent = `‚Ä¢ Real-time data`;
                }
            }
        }

        // Update dashboard with real data
        function updateDashboard(data) {
            console.log('üìä Updating dashboard with data...');

            const { statistics, executionResult, metadata } = data;

            // Update architecture diagram first
            updateDiagramMetrics(data);

            // Flight Statistics
            document.getElementById('total-flights').textContent = formatNumber(statistics.total_flights || 0);
            document.getElementById('flights-airborne').textContent = formatNumber(statistics.flights_airborne || 0);
            document.getElementById('flights-ground').textContent = formatNumber(statistics.flights_on_ground || 0);
            document.getElementById('flights-position').textContent = formatNumber(statistics.flights_with_position || 0);

            // Processing Status
            document.getElementById('records-processed').textContent = formatNumber(executionResult.records_processed || 0);

            const statusElement = document.getElementById('processing-status');
            statusElement.textContent = executionResult.status || 'Unknown';
            statusElement.className = `status ${(executionResult.status === 'SUCCESS') ? 'success' : 'error'}`;

            document.getElementById('execution-id').textContent = executionResult.execution_id || '-';
            document.getElementById('last-updated').textContent = formatDateTime(executionResult.last_modified);

            // Data Source
            document.getElementById('s3-file').textContent = extractFileNameFromPath(executionResult.s3_key);
            document.getElementById('file-size').textContent = formatBytes(metadata.file_size_bytes || 0);
            document.getElementById('data-timestamp').textContent = formatDateTime(statistics.data_timestamp);
            document.getElementById('bucket-name').textContent = metadata.bucket_name || '-';

            // Flight Performance
            const altStats = statistics.altitude_stats || {};
            const speedStats = statistics.speed_stats || {};

            document.getElementById('mean-altitude').textContent =
                altStats.mean_altitude_ft ? `${Math.round(altStats.mean_altitude_ft).toLocaleString()} ft` : '-';
            document.getElementById('max-altitude').textContent =
                altStats.max_altitude_ft ? `${Math.round(altStats.max_altitude_ft).toLocaleString()} ft` : '-';
            document.getElementById('mean-speed').textContent =
                speedStats.mean_speed_knots ? `${Math.round(speedStats.mean_speed_knots)} knots` : '-';
            document.getElementById('max-speed').textContent =
                speedStats.max_speed_knots ? `${Math.round(speedStats.max_speed_knots)} knots` : '-';

            // Update tables
            updateCountriesTable(statistics.top_10_countries || {}, statistics.total_flights || 0);
            updateFastestTable(statistics.top_10_fastest_aircraft || []);

            // Update last refresh time
            document.getElementById('last-refresh').textContent = new Date().toLocaleString();

            console.log('‚úÖ Dashboard updated successfully');
        }

        function updateCountriesTable(countries, totalFlights) {
            const tbody = document.getElementById('countries-table');
            if (!countries || Object.keys(countries).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No data available</td></tr>';
                return;
            }

            const rows = Object.entries(countries)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([country, count], index) => {
                    const percentage = totalFlights > 0 ? ((count / totalFlights) * 100).toFixed(1) : '0.0';
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${country}</td>
                            <td>${formatNumber(count)}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                }).join('');

            tbody.innerHTML = rows;
        }

        function updateFastestTable(aircraft) {
            const tbody = document.getElementById('fastest-table');
            if (!aircraft || aircraft.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data available</td></tr>';
                return;
            }

            const rows = aircraft.slice(0, 10).map((plane, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${plane.callsign || '-'}</td>
                    <td>${plane.origin_country || '-'}</td>
                    <td>${plane.velocity_knots ? Math.round(plane.velocity_knots).toLocaleString() : '-'}</td>
                    <td>${plane.baro_altitude_ft ? Math.round(plane.baro_altitude_ft).toLocaleString() : '-'}</td>
                </tr>
            `).join('');

            tbody.innerHTML = rows;
        }

        // Set diagram loading state
        function setDiagramLoadingState() {
            const diagramElements = [
                'diagram-records',
                'diagram-processing',
                'diagram-countries',
                'diagram-success',
                'diagram-airborne'
            ];

            diagramElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '‚Ä¢ Loading...';
                }
            });
        }

        // Set diagram error state
        function setDiagramErrorState() {
            const diagramElements = [
                { id: 'diagram-records', text: '‚Ä¢ Data unavailable' },
                { id: 'diagram-processing', text: '‚Ä¢ Processing paused' },
                { id: 'diagram-countries', text: '‚Ä¢ Global coverage' },
                { id: 'diagram-success', text: '‚Ä¢ Reconnecting...' },
                { id: 'diagram-airborne', text: '‚Ä¢ Real-time data' }
            ];

            diagramElements.forEach(({ id, text }) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                }
            });
        }

        // Refresh data function
        async function refreshData() {
            setRefreshButtonState(true);
            setDiagramLoadingState();
            clearError();

            try {
                const data = await fetchFlightData();
                updateDashboard(data);
                console.log('üîÑ Data refresh completed');
            } catch (error) {
                console.error('‚ùå Failed to refresh data:', error);
                showError(`Failed to load flight data: ${error.message}`);
                setDiagramErrorState();
            } finally {
                setRefreshButtonState(false);
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            console.log('üöÄ Initializing Flight Data Dashboard...');
            await refreshData();

            // Set up auto-refresh
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(refreshData, CONFIG.REFRESH_INTERVAL);

            console.log(`‚è∞ Auto-refresh enabled (${CONFIG.REFRESH_INTERVAL / 60000} minutes)`);
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>